name: Daily Stock Miner

on:
  schedule:
    # 20:00 WIB = 13:00 UTC
    - cron: '0 13 * * 1-5' # Senin - Jumat
  workflow_dispatch: # Memungkinkan eksekusi manual

jobs:
  mine:
    name: "Mine: ${{ matrix.mode }} (Batch ${{ matrix.batch }})"
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false # Biar kalau 1 robot error, yang lain tetep jalan
      matrix:
        include:
          # Tangan 1: Fokus Makro & Ekonomi Global
          - mode: "macro"
            batch: 0
            total_batches: 1
          
          # Tangan 2: Saham Kloter A (Setengah pertama)
          - mode: "stocks"
            batch: 0
            total_batches: 2
            
          # Tangan 3: Saham Kloter B (Setengah kedua)
          - mode: "stocks"
            batch: 1
            total_batches: 2

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Cache Hugging Face models
        uses: actions/cache@v3
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-models-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-hf-models-

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute Daily Miner
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: python src/scripts/mine_daily.py --mode ${{ matrix.mode }} --batch ${{ matrix.batch }} --total-batches ${{ matrix.total_batches }}

      - name: Report Status
        if: always()
        run: |
          echo "Mining session (${{ matrix.mode }}) finished with status: ${{ job.status }}"
