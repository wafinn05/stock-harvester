name: Daily Stock Miner

on:
  schedule:
    # 20:00 WIB = 13:00 UTC
    - cron: '0 13 * * 1-5' # Senin - Jumat
  workflow_dispatch: # Memungkinkan eksekusi manual

jobs:
  mine:
    name: Run Python Mining Script
    runs-on: ubuntu-latest
    
    # Supaya tidak tabrakan jika ada 2 run bersamaan
    concurrency:
      group: mining-group
      cancel-in-progress: false

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Cache Hugging Face models
        uses: actions/cache@v3
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-models-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-hf-models-

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute Daily Miner
        env:
          # Pastikan rahasia ini sudah di-set di GitHub Secrets Repo Public
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }} # Butuh untuk IndoBERT jika download model
        run: python src/scripts/mine_daily.py

      - name: Report Status
        if: always()
        run: |
          echo "Mining session finished with status: ${{ job.status }}"
